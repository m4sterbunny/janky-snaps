{"version":3,"sources":["../src/eval-worker.ts"],"sourcesContent":["// eslint-disable-next-line import/no-unassigned-import\nimport 'ses/lockdown';\n\nimport { readFileSync } from 'fs';\n\nimport type { HandlerType } from './handler-types';\nimport { SNAP_EXPORT_NAMES } from './handler-types';\nimport { generateMockEndowments } from './mock';\n\ndeclare let lockdown: any, Compartment: any;\n\nlockdown({\n  consoleTaming: 'unsafe',\n  errorTaming: 'unsafe',\n  mathTaming: 'unsafe',\n  dateTaming: 'unsafe',\n  overrideTaming: 'severe',\n\n  // We disable domain taming, because it does not work in certain cases when\n  // running tests. This is unlikely to be a problem in production, because\n  // Node.js domains are deprecated.\n  domainTaming: 'unsafe',\n});\n\nconst snapFilePath = process.argv[2];\n\nconst snapModule: { exports?: any } = { exports: {} };\n\nconst compartment = new Compartment({\n  ...generateMockEndowments(),\n  module: snapModule,\n  exports: snapModule.exports,\n});\n\n// Mirror BaseSnapExecutor\ncompartment.globalThis.self = compartment.globalThis;\ncompartment.globalThis.global = compartment.globalThis;\ncompartment.globalThis.window = compartment.globalThis;\n\ncompartment.evaluate(readFileSync(snapFilePath, 'utf8'));\n\nconst invalidExports = Object.keys(snapModule.exports).filter(\n  (snapExport) => !SNAP_EXPORT_NAMES.includes(snapExport as HandlerType),\n);\n\nif (invalidExports.length > 0) {\n  // eslint-disable-next-line no-console\n  console.warn(`Invalid snap exports detected:\\n${invalidExports.join('\\n')}`);\n}\n\n// To ensure the worker exits we explicitly call exit here\n// If we didn't the eval would wait for timers set during Compartment eval\nprocess.exit(0);\n"],"mappings":";;;;;;;;;;AACA,OAAO;AAEP,SAAS,oBAAoB;AAQ7B,SAAS;AAAA,EACP,eAAe;AAAA,EACf,aAAa;AAAA,EACb,YAAY;AAAA,EACZ,YAAY;AAAA,EACZ,gBAAgB;AAAA;AAAA;AAAA;AAAA,EAKhB,cAAc;AAChB,CAAC;AAED,IAAM,eAAe,QAAQ,KAAK,CAAC;AAEnC,IAAM,aAAgC,EAAE,SAAS,CAAC,EAAE;AAEpD,IAAM,cAAc,IAAI,YAAY;AAAA,EAClC,GAAG,uBAAuB;AAAA,EAC1B,QAAQ;AAAA,EACR,SAAS,WAAW;AACtB,CAAC;AAGD,YAAY,WAAW,OAAO,YAAY;AAC1C,YAAY,WAAW,SAAS,YAAY;AAC5C,YAAY,WAAW,SAAS,YAAY;AAE5C,YAAY,SAAS,aAAa,cAAc,MAAM,CAAC;AAEvD,IAAM,iBAAiB,OAAO,KAAK,WAAW,OAAO,EAAE;AAAA,EACrD,CAAC,eAAe,CAAC,kBAAkB,SAAS,UAAyB;AACvE;AAEA,IAAI,eAAe,SAAS,GAAG;AAE7B,UAAQ,KAAK;AAAA,EAAmC,eAAe,KAAK,IAAI,CAAC,EAAE;AAC7E;AAIA,QAAQ,KAAK,CAAC;","names":[]}